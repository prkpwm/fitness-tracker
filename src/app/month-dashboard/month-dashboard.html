<div class="month-dashboard">
  @if (loading) {
  <div class="loading">
    <div class="loading-spinner"></div>
    <p>Loading ...</p>
  </div>
  } @else {
  <div class="month-header">
    <div class="month-nav-group">
      <button class="month-nav" (click)="changeMonth(-1)">â—€</button>
      <h2 class="month-title">ðŸ“… {{getMonthName()}}</h2>
      <button class="month-nav" (click)="changeMonth(1)">â–¶</button>
    </div>
    <button class="copy-api-btn" (click)="copyRawApiResponse()" title="Export Raw API Response">ðŸ“‹ Export</button>
  </div>

  <div class="month-stats">
    <div class="stat-card">
      <div class="stat-icon">ðŸ“Š</div>
      <div class="stat-value">{{monthlyStats.activeDays}}/{{monthlyStats.totalDays}}</div>
      <div class="stat-label">Active Days</div>
      <div class="completion-bar">
        <div class="completion-fill" [style.width.%]="getCompletionRate()"></div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">ðŸ”¥</div>
      <div class="stat-value">{{monthlyStats.avgCalories | number:'1.0-0'}}</div>
      <div class="stat-label">Avg Calories</div>
      <div class="additional-stats">
        <div class="additional-stat">
          <span class="additional-label">Total Calories:</span>
          <span class="additional-value">{{getTotalCalories() | number:'1.0-0'}}</span>
        </div>
      </div>
      <div class="">
        <div class="additional-stat">
          <span class="additional-label">Min/Max:</span>
          <span class="additional-value">{{getMinCalories() | number:'1.0-0'}}/{{getMaxCalories() | number:'1.0-0'}}</span>
        </div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">ðŸ¥›</div>
      <div class="stat-value">{{monthlyStats.avgProtein | number:'1.0-0'}}g</div>
      <div class="stat-label">Avg Protein</div>
      <div class="additional-stats">
        <div class="additional-stat">
          <span class="additional-label">Total Protein:</span>
          <span class="additional-value">{{getTotalProtein() | number:'1.0-0'}}g</span>
        </div>
      </div>
      <div class="">
        <div class="additional-stat">
          <span class="additional-label">Min/Max:</span>
          <span class="additional-value">{{getMinProtein() | number:'1.0-0'}}/{{getMaxProtein() | number:'1.0-0'}}g</span>
        </div>
      </div>
    </div>

    <div class="stat-card activity-analysis">
      <div class="stat-icon">âš¡</div>
      <div class="stat-value">{{monthlyStats.totalBurned | number:'1.0-0'}}</div>
      <div class="stat-label">Total Burned</div>
      <div class="stat-sublabel">{{getBurnedStatus()}}</div>
      <div class="additional-stats">
        <div class="additional-stat">
          <span class="additional-label">Avg Daily:</span>
          <span class="additional-value">{{getAvgBurned() | number:'1.0-0'}} cal</span>
        </div>
        <div class="additional-stat">
          <span class="additional-label">Min/Max:</span>
          <span class="additional-value">{{getMinBurned() | number:'1.0-0'}}/{{getMaxBurned() | number:'1.0-0'}} cal</span>
        </div>
        <div class="additional-stat">
          <span class="additional-label">Active Days:</span>
          <span class="additional-value">{{monthlyStats.activeDays}}</span>
        </div>
      </div>
    </div>

    <div class="stat-card net-cal-analysis">
      <div class="stat-icon">ðŸ’¡</div>
      <div class="stat-value" [class]="getDifferenceClass()">{{getCalorieDifference() | number:'1.0-0'}} cal</div>
      <div class="stat-label">Avg Net vs Goal</div>
      <div class="stat-sublabel">{{getNetCalorieRecommendation()}}</div>
      <div class="additional-stats">
        <div class="additional-stat">
          <span class="additional-label">Total Calories:</span>
          <span class="additional-value">{{getTotalCalories() | number:'1.0-0'}}</span>
        </div>
        <div class="additional-stat">
          <span class="additional-label">Est. Weight Loss:</span>
          <span class="additional-value">{{getEstimatedWeightDecrease() | number:'1.1-1'}} kg</span>
        </div>
      </div>
    </div>
  </div>

  <div class="charts-section">
    <div class="chart-container">
      <h3>ðŸ“ˆ Net Calories vs Recommended vs TDEE</h3>
      <div class="chart-wrapper">
        <canvas #calorieChart></canvas>
      </div>
    </div>
  </div>

  <div class="calendar-container">
    <div class="calendar-header">
      <div class="day-header"><span class="day-full">Sun</span><span class="day-short">S</span></div>
      <div class="day-header"><span class="day-full">Mon</span><span class="day-short">M</span></div>
      <div class="day-header"><span class="day-full">Tue</span><span class="day-short">T</span></div>
      <div class="day-header"><span class="day-full">Wed</span><span class="day-short">W</span></div>
      <div class="day-header"><span class="day-full">Thu</span><span class="day-short">T</span></div>
      <div class="day-header"><span class="day-full">Fri</span><span class="day-short">F</span></div>
      <div class="day-header"><span class="day-full">Sat</span><span class="day-short">S</span></div>
    </div>

    <div class="calendar-grid">
      @for (day of calendarDays; track $index) {
        <div class="calendar-day" [class]="day.status" [class.empty]="day.isEmpty" (click)="onDateClick(day)" [class.clickable]="!day.isEmpty">
          @if (!day.isEmpty) {
            <div class="day-number">{{day.day}}</div>
            @if (day.hasData) {
              <div class="day-calories">In: {{day.data.daily_total_stats.total_intake_calories | number:'1.0-0'}}</div>
              <div class="day-burn">Out: {{day.data.exercise_summary?.total_burned_calories || 0 | number:'1.0-0'}}</div>
              <div class="day-net">Net: {{day.data.daily_total_stats.net_calories | number:'1.0-0'}}</div>
              <div class="day-indicator" [class]="day.status"></div>
            }
          }
        </div>
      }
    </div>
  </div>

  <div class="legend">
    <div class="legend-item">
      <div class="legend-dot deficit"></div>
      <span>Deficit</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot maintenance"></div>
      <span>Maintenance</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot surplus"></div>
      <span>Surplus</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot no-data"></div>
      <span>No Data</span>
    </div>
  </div>
  }
</div>